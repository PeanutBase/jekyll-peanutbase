---
layout: default
title: ArachisMine gene keyword search
---

<script type="text/javascript" src="./js/graphql.js"></script>
<script type="module" src="./js/web-components.bundled.js"></script>

<h2>ArachisMine Gene Keyword Search</h2>

<div class="uk-container">
  <!-- the custom gene search element -->
  <lis-gene-search-element id="gene-search"></lis-gene-search-element>
</div>

<!-- set the search function by property because functions can't be set as attributes -->
<script type="text/javascript">
  const geneQuery = `
    query Query($description: String!, $start: Int, $size: Int) {
      genes(description: $description, start: $start, size: $size) {
        id
        name
        description
      }
    }
  `;

  // the search function given to the LIS gene search webcomponent
  function getGenes(searchData, page, {abortSignal}) {
    const description = searchData['query'];
    const pageSize = 10;
    const start = (page-1)*pageSize;
    const variables = {description, start, size: pageSize+1};
    // returns a Promise that resolves to an array of Gene objects the gene search
    // webcomponent knows how to parse: {name: string, description: string}[]
    return graphqlQuery(uri, geneQuery, variables, abortSignal)
      .then(({data}) => {
        const hasNext = pageSize+1 === data.genes.length;
        // remove the lookahead result
        if (hasNext) data.genes.pop();
        for (var gene of data.genes) {
          gene.name = '<a href="https://mines.legumeinfo.org/arachismine/report.do?id=' + gene.id + '" target="_blank">' + gene.name + '</a>';
          if (gene.description == null) {
            gene.description = '';
          } else {
            const regexGo = /(GO:\d+)/g;
            const matchGo = [ gene.description.match(regexGo) ][0];
            if (matchGo != null) {
              for (var m of matchGo) {
                gene.description = gene.description.replace(m, '<a href="http://amigo.geneontology.org/amigo/term/' + m + '" target="_blank">' + m + '</a>');
              }
            }
            const regexIpr = /(IPR\d+)/g;
            const matchIpr = [ gene.description.match(regexIpr) ][0];
            if (matchIpr != null) {
              for (var m of matchIpr) {
                gene.description = gene.description.replace(m, '<a href="https://www.ebi.ac.uk/interpro/entry/' + m + '" target="_blank">' + m + '</a>');
              }
            }
          }
        }
        // construct the expected paginated results object
        const paginatedResults = {
          hasNext,
          results: data.genes,
        };
        return paginatedResults;
      }
    );
  }

  const geneSearchElement = document.getElementById('gene-search');
  geneSearchElement.searchFunction = getGenes;
</script>

