---
layout: default
title: ArachisMine gene keyword search
---

<script type="text/javascript" src="./js/graphql.js"></script>
<script type="module" src="./js/web-components.bundled.js"></script>

<h2>ArachisMine Gene Keyword Search</h2>

<div class="uk-container">
  <!-- the custom gene search element -->
  <lis-gene-search-element id="gene-search"></lis-gene-search-element>
</div>

<!-- set the search function by property because functions can't be set as attributes -->
<script type="text/javascript">
  // uses the LIS GraphQL API to get data used to construct the gene search form
  const geneFormDataQuery = `
    query FormDataQuery {
      organisms {
        genus
        species
        strains {
          identifier
        }
      }
    }
  `;

  function getGeneFormData({abortSignal}) {
    return graphqlQuery(uri, geneFormDataQuery, {}, abortSignal)
      .then(({data}) => {
        // bin the strains by genus then species
        const binnedFormData = {};
        data.organisms.forEach(({genus, species, strains}) => {
          if (!(genus in binnedFormData)) {
            binnedFormData[genus] = {}
          }
          if (!(species in binnedFormData[genus])) {
            binnedFormData[genus][species] = [];
          }
          binnedFormData[genus][species].push(...strains);
        });
        // collapse the bins into arrays of objects
        const genuses =
          Object.entries(binnedFormData).map(([genus, binnedSpecies]) => {
            const species =
              Object.entries(binnedSpecies).map(([species, strainObjects]) => {
                const strains = strainObjects.map(({identifier}) => {
                  return {strain: identifier};
                });
                return {species, strains};
              });
            return {genus, species};
          });
        // return the expected form data object
        return {genuses};
      });
  }

  const geneQuery = `
    query Query($identifier: String, $name: String, $description: String, $genus: String, $species: String, $strain: String, $geneFamilyIdentifier: String, $start: Int, $size: Int) {
      genes(genus: $genus, species: $species, strain: $strain, identifier: $identifier, name: $name, description: $description, geneFamilyIdentifier: $geneFamilyIdentifier, start: $start, size: $size) {
        id
        identifier
        name
        description
        organism { genus species }
        strain { identifier }
        geneFamilyAssignments { geneFamily { identifier } }
        locations { chromosome { identifier } supercontig { identifier } start end strand }
      }
    }
  `;

  // the search function given to the LIS gene search webcomponent
  function getGenes(searchData, page, {abortSignal}) {
    const genus = searchData['genus'];
    const species = searchData['species'];
    const strain = searchData['strain'];
    const identifier = searchData['identifier'];
    const description = searchData['description'];
    const geneFamilyIdentifier = searchData['geneFamilyIdentifier'];
    const pageSize = 10;
    const start = (page-1)*pageSize;
    // pageSize+1 because we want to see if there's a "next" page
    const variables = {
      genus,
      species,
      strain,
      identifier,
      description,
      geneFamilyIdentifier,
      start,
      size: pageSize+1
    };
    // returns a Promise that resolves to an array of Gene objects the gene search
    // webcomponent knows how to parse: {name: string, description: string}[]
    return graphqlQuery(uri, geneQuery, variables, abortSignal)
      .then(({data}) => {
        const hasNext = pageSize+1 === data.genes.length;
        // remove the lookahead result
        if (hasNext) data.genes.pop();
        for (var gene of data.genes) {
          gene.name = '<a href="https://mines.legumeinfo.org/arachismine/report.do?id=' + gene.id + '" target="_blank">' + gene.name + '</a>';
          if (gene.description == null) {
            gene.description = '';
          } else {
            const regexGo = /(GO:\d+)/g;
            const matchGo = [ gene.description.match(regexGo) ][0];
            if (matchGo != null) {
              for (var m of matchGo) {
                gene.description = gene.description.replace(m, '<a href="http://amigo.geneontology.org/amigo/term/' + m + '" target="_blank">' + m + '</a>');
              }
            }
            const regexIpr = /(IPR\d+)/g;
            const matchIpr = [ gene.description.match(regexIpr) ][0];
            if (matchIpr != null) {
              for (var m of matchIpr) {
                gene.description = gene.description.replace(m, '<a href="https://www.ebi.ac.uk/interpro/entry/' + m + '" target="_blank">' + m + '</a>');
              }
            }
          }
        }
        // flatten results
        const results =
          data.genes.map(({organism: {genus, species}, strain, ...gene}) => {
            const geneFamilyAssignments =
              gene.geneFamilyAssignments
                .map(({geneFamily: {identifier}}) => identifier);
            const locations =
              gene.locations.map(({chromosome, supercontig, start, end, strand}) => {
                const interval = `${start}-${end} (${strand})`;
                if (chromosome?.identifier) {
                  return `${chromosome?.identifier}:${interval} (chromosome)`;
                } else if (supercontig?.identifier) {
                  return `${supercontig?.identifier}:${interval} (supercontig)`;
                }
                return `unknown:${interval}`;
              });
            return {
              genus,
              species,
              strain: strain.identifier,
              ...gene,
              geneFamilyAssignments,
              locations,
            };
          });
        // construct the expected paginated results object
        const paginatedResults = { hasNext, results };
        return paginatedResults;
      }
    );
  }

  const geneSearchElement = document.getElementById('gene-search');
  geneSearchElement.formDataFunction = getGeneFormData;
  geneSearchElement.searchFunction = getGenes;
</script>

